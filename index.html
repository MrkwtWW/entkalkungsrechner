<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entkalkungsrechner</title>
<style>
  :root {
    --bg: #f4f7fb;
    --card: #ffffff;
    --accent1: #c2cb20;
    --accent2: #341e17;
    --muted: #6b7280;
    --glass: rgba(255, 255, 255, 0.7);
    --progress-green: #4caf50;
    --progress-yellow: #c2cb20;
    --progress-red: #341e17;
    --blue-water: #2196f3;
  }
  * {
    box-sizing: border-box;
  }
  body {
    font-family: Inter, "Helvetica Neue", Arial, sans-serif;
    background: var(--bg);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    margin: 0;
    transition: background-color 0.3s, color 0.3s;
  }
  body[data-theme='dark'] {
    background: #222;
    color: #eee;
  }
  .card {
    width: 100%;
    max-width: 820px;
    background: var(--card);
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(18, 38, 63, 0.08);
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 20px;
    align-items: start;
    transition: background-color 0.3s, color 0.3s;
  }
  body[data-theme='dark'] .card {
    background: #333;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
  }
  h1 {
    margin: 0 0 8px 0;
    font-size: 20px;
  }
  p.lead {
    margin: 0 0 16px 0;
    color: var(--muted);
    font-size: 14px;
  }
  label {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 6px;
    display: block;
  }
  input[type="number"],
  input[type="text"],
  input[type="date"] {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #e6e9ef;
    font-size: 15px;
    outline: none;
    background: transparent;
    color: inherit;
    transition: border-color 0.3s;
  }
  body[data-theme='dark'] input[type="number"],
  body[data-theme='dark'] input[type="text"],
  body[data-theme='dark'] input[type="date"] {
    border-color: #555;
    background: #444;
  }
  input[type="number"]:focus,
  input[type="text"]:focus,
  input[type="date"]:focus {
    border-color: var(--accent1);
  }
  .controls > div {
    margin-bottom: 16px;
  }
  .row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  button {
    padding: 10px 12px;
    border-radius: 10px;
    border: none;
    font-size: 15px;
    cursor: pointer;
    background: var(--accent1);
    color: var(--accent2);
    box-shadow: 0 6px 18px rgba(194, 203, 32, 0.18);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.3s;
  }
  button:hover:not(:disabled) {
    background: var(--accent2);
    color: var(--accent1);
  }
  button.ghost {
    background: transparent;
    color: var(--muted);
    border: 1px solid #e6e9ef;
    box-shadow: none;
  }
  body[data-theme='dark'] button.ghost {
    border-color: #555;
    color: #aaa;
  }
  button.small {
    padding: 8px 10px;
    font-size: 14px;
    border-radius: 8px;
  }
  button:disabled,
  button[disabled] {
    opacity: 0.5;
    cursor: default;
  }
  .muted {
    color: var(--muted);
    font-size: 13px;
  }
  /* right column */
  .display {
    padding: 12px;
    border-radius: 10px;
    background: linear-gradient(180deg, #fafbfd, #f6f9fc);
    min-height: 280px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    align-items: center;
    transition: background-color 0.3s;
  }
  body[data-theme='dark'] .display {
    background: linear-gradient(180deg, #444, #222);
  }
  .tank-wrap {
    width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  svg {
    width: 100%;
    height: auto;
    display: block;
  }
  .stats {
    flex: 1;
    width: 100%;
  }
  .big {
    font-size: 18px;
    font-weight: 600;
  }
  .percent {
    font-size: 13px;
    color: var(--muted);
    margin-top: 6px;
  }
  .notice {
    margin-top: 8px;
    font-weight: 600;
    color: #c53030;
    display: none;
  }
  .hardness-warning {
    margin-top: 8px;
    font-weight: 600;
    color: var(--accent1);
    display: none;
  }
  .fillbar {
    height: 10px;
    width: 100%;
    background: #e6eef0;
    border-radius: 999px;
    overflow: hidden;
    margin-top: 8px;
  }
  body[data-theme='dark'] .fillbar {
    background: #555;
  }
  .fill {
    height: 100%;
    width: 0%;
    background: var(--blue-water);
    transition: width 0.4s, background-color 0.4s;
  }
  footer {
    grid-column: 1 / -1;
    text-align: center;
    margin-top: 8px;
    font-size: 12px;
    color: var(--muted);
  }
  /* Darkmode toggle bottom */
  #themeToggleWrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 12px;
    cursor: pointer;
    user-select: none;
  }
  #themeToggleWrapper svg {
    width: 20px;
    height: 20px;
  }
  #themeToggleWrapper:focus {
    outline: 2px solid var(--accent1);
    outline-offset: 2px;
  }
  @media (max-width: 800px) {
    .card {
      grid-template-columns: 1fr;
      padding: 16px;
    }
    .display {
      flex-direction: row;
      gap: 16px;
      min-height: auto;
    }
  }
</style>
</head>
<body>

<div class="card" role="application" aria-label="Entkalkungsrechner">
  <div class="controls">
    <h1>Entkalkungsrechner</h1>
    <p class="lead">Gib die Wasserhärte ein. Rechner: <strong>2000 ÷ Härte = Liter bis zur nächsten Entkalkung</strong>.</p>

    <div>
      <label for="waterHardness">Wasserhärte (°dH)</label>
      <input id="waterHardness" type="number" min="0.1" step="0.1" value="20" autocomplete="off" />
    </div>

    <div>
      <label for="tankCapacity">Wassertank-Kapazität (L)</label>
      <div class="row">
        <input id="tankCapacity" type="number" min="0" step="0.1" value="2.8" />
        <button id="useTankButton" class="small" title="Tankinhalt zum Verbrauch hinzufügen">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden focusable="false" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3s5 5 5 8a5 5 0 11-10 0c0-3 5-8 5-8z" fill="var(--blue-water)" />
          </svg>
          Tank verbrauchen
        </button>
      </div>
      <div class="hint">Klick addiert den Tankinhalt zur Verbrauchszählung (z. B. 2.8 L).</div>
    </div>

    <div style="margin-top:12px;">
      <label for="consumeInput">Manuell Liter hinzufügen (z. B. 1)</label>
      <div class="row">
        <input id="consumeInput" type="number" min="0" step="0.1" value="1" />
        <button id="consumeButton" class="small">Hinzufügen</button>
        <button id="consume1Button" class="small ghost">Schnell +1 L</button>
      </div>
      <div class="hint">Gib z. B. 1 L ein, um Liter zum Verbrauch zu addieren.</div>
    </div>

    <div style="margin-top:16px;" class="row" aria-label="Rückgängig und Reset Buttons">
      <button id="undoButton" class="ghost small" disabled title="Letzten Schritt rückgängig machen" aria-disabled="true">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Rückgängig
      </button>
      <button id="resetButton" class="ghost small" disabled title="Alles zurücksetzen" aria-disabled="true">
        Reset
      </button>
    </div>

    <div style="margin-top:16px;">
      <label for="descaleDate">Entkalkungstermin wählen</label>
      <input type="date" id="descaleDate" />
    </div>

    <div style="margin-top:8px;">
      <button id="addCalendarBtn" class="small" disabled>Termin zum Kalender hinzufügen</button>
    </div>

  </div>

  <div class="display" aria-live="polite">
    <div class="tank-wrap" role="img" aria-label="Tank-Füllstand">
      <svg id="tankSvg" viewBox="0 0 120 260" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <rect x="12" y="20" rx="12" ry="12" width="96" height="200" fill="none" stroke="#d6dde3" stroke-width="4" />
        <rect id="fillRect" x="12" y="220" width="96" height="0" rx="10" ry="10" fill="var(--blue-water)" />
        <path d="M60 12c-4 0-16 12-16 24 0 22 32 22 32 0 0-12-12-24-16-24z" fill="var(--blue-water)" opacity="0.9" />
      </svg>
    </div>

    <div class="stats">
      <div class="big" id="litersToDescaleText">Nächste Entkalkung: — L</div>
      <div class="muted" id="remainingText">Verbleibend: — L</div>
      <div class="fillbar" aria-hidden="true">
        <div class="fill" id="progressFill" style="width:0%"></div>
      </div>
      <div class="percent" id="percentText">—%</div>
      <div class="notice" id="notice">Jetzt entkalken!</div>
      <div class="hardness-warning" id="hardnessWarning">Achtung: Häufigeres Entkalken empfohlen (Wasserhärte über 21 °dH)!</div>
    </div>
  </div>

  <footer>Hinweis: Formel = <strong>2000 ÷ Wasserhärte</strong>. Beispiel: 2000 ÷ 20 = 100 L</footer>
</div>

<div id="themeToggleWrapper" role="button" tabindex="0" aria-pressed="false" aria-label="Darkmode umschalten">
  <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="display:inline-block;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
  <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="display:none;">
    <path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0021 12.79z"></path>
  </svg>
</div>

<script>
(function() {
  let usedLiters = 0;
  let litersToDescale = null;
  let undoStack = [];

  const waterHardnessInput = document.getElementById('waterHardness');
  const resetButton = document.getElementById('resetButton');

  const tankCapacityInput = document.getElementById('tankCapacity');
  const useTankButton = document.getElementById('useTankButton');

  const consumeInput = document.getElementById('consumeInput');
  const consumeButton = document.getElementById('consumeButton');
  const consume1Button = document.getElementById('consume1Button');

  const undoButton = document.getElementById('undoButton');

  const litersToDescaleText = document.getElementById('litersToDescaleText');
  const remainingText = document.getElementById('remainingText');
  const progressFill = document.getElementById('progressFill');
  const percentText = document.getElementById('percentText');
  const notice = document.getElementById('notice');
  const hardnessWarning = document.getElementById('hardnessWarning');
  const fillRect = document.getElementById('fillRect');

  const descaleDateInput = document.getElementById('descaleDate');
  const addCalendarBtn = document.getElementById('addCalendarBtn');

  const themeToggleWrapper = document.getElementById('themeToggleWrapper');
  const sunIcon = document.getElementById('sunIcon');
  const moonIcon = document.getElementById('moonIcon');

  function fmt(n) {
    if (n === null || isNaN(n)) return '—';
    return Math.abs(n) >= 1000 ? n.toFixed(0) : n.toFixed(2);
  }

  function enableControls(enabled) {
    useTankButton.disabled = !enabled;
    consumeButton.disabled = !enabled;
    consume1Button.disabled = !enabled;
    undoButton.disabled = !enabled || undoStack.length === 0;
    resetButton.disabled = !enabled;
    addCalendarBtn.disabled = !enabled;
  }

  function updateDisplay() {
    if (litersToDescale === null) {
      litersToDescaleText.textContent = 'Nächste Entkalkung: — L';
      remainingText.textContent = 'Verbleibend: — L';
      percentText.textContent = '—%';
      progressFill.style.width = '0%';
      notice.style.display = 'none';
      hardnessWarning.style.display = 'none';
      fillRect.setAttribute('height', 0);
      fillRect.setAttribute('y', 220);
      enableControls(false);
      return;
    }

    const remaining = litersToDescale - usedLiters;
    const perc = Math.min(100, (usedLiters / litersToDescale) * 100);

    litersToDescaleText.textContent = `Nächste Entkalkung: ${fmt(litersToDescale)} L`;
    remainingText.textContent = `Verbleibend: ${fmt(remaining)} L`;
    percentText.textContent = `${perc.toFixed(0)}%`;

    progressFill.style.width = perc + '%';

    // Tankfüllung Höhe (max 200)
    const fillHeight = Math.round((usedLiters / litersToDescale) * 200);
    fillRect.setAttribute('height', fillHeight);
    fillRect.setAttribute('y', 220 - fillHeight);

    notice.style.display = remaining <= 0 ? 'block' : 'none';

    if (parseFloat(waterHardnessInput.value) > 21) {
      hardnessWarning.style.display = 'block';
    } else {
      hardnessWarning.style.display = 'none';
    }

    enableControls(true);
  }

  function saveState() {
    const state = {
      usedLiters,
      litersToDescale,
      undoStack,
      waterHardness: waterHardnessInput.value,
      tankCapacity: tankCapacityInput.value,
      descaleDate: descaleDateInput.value
    };
    localStorage.setItem('entkalkungsrechner', JSON.stringify(state));
  }

  function loadState() {
    const state = localStorage.getItem('entkalkungsrechner');
    if (!state) return;
    try {
      const obj = JSON.parse(state);
      usedLiters = obj.usedLiters || 0;
      litersToDescale = obj.litersToDescale || null;
      undoStack = obj.undoStack || [];
      waterHardnessInput.value = obj.waterHardness || 20;
      tankCapacityInput.value = obj.tankCapacity || 2.8;
      descaleDateInput.value = obj.descaleDate || '';
      updateDisplay();
      undoButton.disabled = undoStack.length === 0;
      resetButton.disabled = litersToDescale === null;
      addCalendarBtn.disabled = litersToDescale === null;
    } catch (e) {}
  }

  // Berechnung automatisch beim Wasserhärte ändern
  waterHardnessInput.addEventListener('input', () => {
    const hardness = parseFloat(waterHardnessInput.value);
    if (isNaN(hardness) || hardness <= 0) {
      litersToDescale = null;
      usedLiters = 0;
      undoStack = [];
      updateDisplay();
      saveState();
      return;
    }
    litersToDescale = 2000 / hardness;
    if (usedLiters > litersToDescale) usedLiters = litersToDescale;
    updateDisplay();
    saveState();
  });

  resetButton.addEventListener('click', () => {
    if (!confirm('Sind Sie sicher, dass Sie alle Daten zurücksetzen möchten?')) return;
    usedLiters = 0;
    litersToDescale = null;
    undoStack = [];
    waterHardnessInput.value = '';
    tankCapacityInput.value = '2.8';
    descaleDateInput.value = '';
    updateDisplay();
    saveState();
  });

  useTankButton.addEventListener('click', () => {
    if (litersToDescale === null) return;
    const tank = parseFloat(tankCapacityInput.value);
    if (isNaN(tank) || tank <= 0) {
      alert('Bitte gültige Tankkapazität eingeben.');
      return;
    }
    undoStack.push(usedLiters);
    usedLiters += tank;
    if (usedLiters > litersToDescale) usedLiters = litersToDescale;
    updateDisplay();
    undoButton.disabled = false;
    resetButton.disabled = false;
    saveState();
  });

  consumeButton.addEventListener('click', () => {
    if (litersToDescale === null) return;
    const amount = parseFloat(consumeInput.value);
    if (isNaN(amount) || amount <= 0) {
      alert('Bitte gültigen Wert zum Hinzufügen eingeben (größer 0).');
      return;
    }
    undoStack.push(usedLiters);
    usedLiters += amount;
    if (usedLiters > litersToDescale) usedLiters = litersToDescale;
    updateDisplay();
    undoButton.disabled = false;
    resetButton.disabled = false;
    saveState();
  });

  consume1Button.addEventListener('click', () => {
    if (litersToDescale === null) return;
    undoStack.push(usedLiters);
    usedLiters += 1;
    if (usedLiters > litersToDescale) usedLiters = litersToDescale;
    updateDisplay();
    undoButton.disabled = false;
    resetButton.disabled = false;
    saveState();
  });

  undoButton.addEventListener('click', () => {
    if (undoStack.length === 0) return;
    usedLiters = undoStack.pop();
    updateDisplay();
    undoButton.disabled = undoStack.length === 0;
    if (undoStack.length === 0) resetButton.disabled = true;
    saveState();
  });

  addCalendarBtn.addEventListener('click', () => {
    if (!descaleDateInput.value) {
      alert('Bitte erst ein Datum für den Entkalkungstermin auswählen.');
      return;
    }
    const date = new Date(descaleDateInput.value);
    if (isNaN(date)) {
      alert('Ungültiges Datum.');
      return;
    }
    const startDate = date.toISOString().split('T')[0].replace(/-/g, '');
    const endDate = new Date(date);
    endDate.setDate(date.getDate() + 1);
    const endDateStr = endDate.toISOString().split('T')[0].replace(/-/g, '');

    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=Entkalkung+fällig&dates=${startDate}/${endDateStr}&details=Entkalkung+deiner+Maschine+fällig+am+${date.toLocaleDateString()}&sf=true&output=xml`;

    window.open(url, '_blank');
  });

  function setTheme(dark) {
    if (dark) {
      document.body.dataset.theme = 'dark';
      sunIcon.style.display = 'none';
      moonIcon.style.display = 'inline-block';
      themeToggleWrapper.setAttribute('aria-pressed', 'true');
      localStorage.setItem('theme', 'dark');
    } else {
      document.body.dataset.theme = 'light';
      sunIcon.style.display = 'inline-block';
      moonIcon.style.display = 'none';
      themeToggleWrapper.setAttribute('aria-pressed', 'false');
      localStorage.setItem('theme', 'light');
    }
  }

  themeToggleWrapper.addEventListener('click', () => {
    const dark = document.body.dataset.theme === 'dark';
    setTheme(!dark);
  });

  themeToggleWrapper.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      themeToggleWrapper.click();
    }
  });

  loadState();

  // Theme initial setzen (Speicherung oder System)
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') setTheme(true);
  else if (savedTheme === 'light') setTheme(false);
  else {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark);
  }
})();
</script>

</body>
</html>
