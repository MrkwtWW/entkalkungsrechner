<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entkalkungsrechner</title>
<style>
  :root {
    --bg: #f4f7fb;
    --card: #ffffff;
    --accent1: #c2cb20;
    --accent2: #341e17;
    --muted: #6b7280;
    --glass: rgba(255, 255, 255, 0.7);
    --progress-green: #4caf50;
    --progress-yellow: #c2cb20;
    --progress-red: #e53935;
    --blue-water: #2196f3;
  }
  * {
    box-sizing: border-box;
  }
  body {
    font-family: Inter, "Helvetica Neue", Arial, sans-serif;
    background: var(--bg);
    min-height: 100vh;
    margin: 0;
    padding: 24px;
    color: #222;
    transition: background-color 0.3s, color 0.3s;
  }
  body[data-theme='dark'] {
    background: #222;
    color: #eee;
  }
  .card {
    max-width: 820px;
    background: var(--card);
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(18, 38, 63, 0.08);
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 20px;
    align-items: start;
    transition: background-color 0.3s, color 0.3s;
    margin: 0 auto;
  }
  body[data-theme='dark'] .card {
    background: #333;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
  }
  h1 {
    margin: 0 0 8px 0;
    font-size: 20px;
  }
  p.lead {
    margin: 0 0 16px 0;
    color: var(--muted);
    font-size: 14px;
  }
  label {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 6px;
    display: block;
  }
  input[type="number"],
  input[type="text"],
  input[type="date"] {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #e6e9ef;
    font-size: 15px;
    outline: none;
    background: transparent;
    color: inherit;
    transition: border-color 0.3s;
  }
  body[data-theme='dark'] input[type="number"],
  body[data-theme='dark'] input[type="text"],
  body[data-theme='dark'] input[type="date"] {
    border-color: #555;
    background: #444;
  }
  input[type="number"]:focus,
  input[type="text"]:focus,
  input[type="date"]:focus {
    border-color: var(--accent1);
  }
  .water-hardness-row {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 16px;
  }
  #waterHardness {
    flex: 1 1 80px;
    max-width: 120px;
  }
  #calculateButton {
    flex: 0 0 auto;
    background: var(--accent1);
    color: var(--accent2);
    padding: 10px 14px;
    border-radius: 10px;
    border: none;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(194, 203, 32, 0.18);
    transition: background-color 0.3s;
  }
  #calculateButton:hover {
    background: var(--accent2);
    color: var(--accent1);
  }
  #calculateButton:disabled {
    opacity: 0.5;
    cursor: default;
  }
  .controls > div {
    margin-bottom: 16px;
  }
  .row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  button {
    padding: 10px 12px;
    border-radius: 10px;
    border: none;
    font-size: 15px;
    cursor: pointer;
    background: var(--accent1);
    color: var(--accent2);
    box-shadow: 0 6px 18px rgba(194, 203, 32, 0.18);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.3s;
  }
  button:hover:not(:disabled) {
    background: var(--accent2);
    color: var(--accent1);
  }
  button.ghost {
    background: transparent;
    color: var(--muted);
    border: 1px solid #e6e9ef;
    box-shadow: none;
  }
  body[data-theme='dark'] button.ghost {
    border-color: #555;
    color: #aaa;
  }
  button.small {
    padding: 8px 10px;
    font-size: 14px;
    border-radius: 8px;
  }
  button:disabled,
  button[disabled] {
    opacity: 0.5;
    cursor: default;
  }
  .muted {
    color: var(--muted);
    font-size: 13px;
  }
  .display {
    padding: 12px;
    border-radius: 10px;
    background: linear-gradient(180deg, #fafbfd, #f6f9fc);
    min-height: 280px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    align-items: center;
    transition: background-color 0.3s;
  }
  body[data-theme='dark'] .display {
    background: linear-gradient(180deg, #444, #222);
  }
  .tank-wrap {
    width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  svg {
    width: 100%;
    height: auto;
    display: block;
  }
  .stats {
    flex: 1;
    width: 100%;
  }
  .big {
    font-size: 18px;
    font-weight: 600;
  }
  .percent {
    font-size: 13px;
    color: var(--muted);
    margin-top: 6px;
  }
  .notice {
    margin-top: 8px;
    font-weight: 600;
    color: #c53030;
    display: none;
  }
  .hardness-warning {
    margin-top: 8px;
    font-weight: 600;
    color: var(--accent1);
    display: none;
  }
  .fillbar {
    height: 10px;
    width: 100%;
    background: #e6eef0;
    border-radius: 999px;
    overflow: hidden;
    margin-top: 8px;
  }
  body[data-theme='dark'] .fillbar {
    background: #555;
  }
  .fill {
    height: 100%;
    width: 0%;
    background: var(--blue-water);
    transition: width 0.4s, background-color 0.4s;
  }
  footer {
    grid-column: 1 / -1;
    text-align: center;
    margin-top: 8px;
    font-size: 12px;
    color: var(--muted);
  }
  #themeToggleWrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 12px;
    cursor: pointer;
    user-select: none;
  }
  #themeToggleWrapper svg {
    width: 20px;
    height: 20px;
  }
  #themeToggleWrapper:focus {
    outline: 2px solid var(--accent1);
    outline-offset: 2px;
  }
 @media (max-width: 600px) {
     /* Wasserhärte Input schmaler */
  #waterHardness {
    flex: 0 0 50px;  /* feste Breite, z.B. 50px */
    max-width: 50px;
  }

  /* Berechnen Button neben Wasserhärte */
  #calculateButton {
    flex: 1 1 auto;
    max-width: 140px;
    width: auto;
  }

  /* Manuell Liter Input schmaler (max. 9999, also 4 Stellen plus ggf. Komma) */
  #consumeInput {
    flex: 0 0 70px; /* z.B. 70px breit */
    max-width: 70px;
  }

  /* +1L Button neben dem manuellen Input */
  #consume1Button {
    flex: 0 0 auto;
    min-width: 60px; /* genug Platz für Text */
  }

  /* Manuell hinzufügen Button (Hinzufügen) ggf. flexibel */
  #consumeButton {
    flex: 1 1 auto;
    max-width: 140px;
    width: auto;
  }

  /* Zeilen besser anordnen und Abstand */
  .water-hardness-row, 
  #consumeInput ~ button,
  .row {
    flex-wrap: nowrap; /* keine Umbrüche */
    gap: 8px;
    align-items: center;
  }
}
  /* Card auf volle Breite */
  .card {
    max-width: 100%;
    padding: 12px;
    grid-template-columns: 1fr !important;
  }

  /* Buttons auf ca. 50% Breite, max. 140px */
  button {
    width: 48%;
    max-width: 140px;
    padding: 8px 10px;
    font-size: 14px;
  }

  /* Kleinere Buttons extra behandeln (z.B. mit .small) */
  button.small {
    width: auto; /* Kleinere Buttons behalten ihre Größe */
    max-width: none;
  }

  /* Buttons in Reihen (z.B. row) ordentlich umbrechen */
  .row {
    flex-wrap: wrap;
  }

  /* Tank-Container kleiner machen und zentrieren */
  .tank-wrap {
    width: 100px;
    margin: 0 auto 12px auto;
  }

  /* Wasserstandanzeige (Display) max. Breite anpassen */
  .display {
    min-height: auto;
    max-width: 100%;
    margin: 0 auto 16px auto;
    padding: 12px;
  }

  /* Hinweis (footer) als Block, volle Breite */
  footer {
    display: block;
    width: 100%;
    padding: 12px 8px;
    font-size: 13px;
    box-sizing: border-box;
    text-align: center;
  }
}
</style>
</head>
<body data-theme="light">

<div class="card" role="application" aria-label="Entkalkungsrechner">

  <div class="controls">
    <h1>Entkalkungsrechner</h1>
    <p class="lead">Gib die Wasserhärte ein. Rechner: <strong>2000 ÷ Härte = Liter bis zur nächsten Entkalkung</strong>.</p>

    <div class="water-hardness-row">
      <label for="waterHardness" style="flex:0 0 auto; margin:0;">Wasserhärte (°dH)</label>
      <input id="waterHardness" type="number" min="0.1" step="0.1" autocomplete="off" aria-describedby="waterHardnessHelp" />
      <button id="calculateButton" disabled aria-label="Berechnen">Berechnen</button>
    </div>
    <div id="waterHardnessHelp" class="muted" style="margin-bottom: 16px;">
      Beispiel: 20 °dH
    </div>

    <div>
      <label for="tankCapacity">Wassertank-Kapazität (L)</label>
      <div class="row">
        <input id="tankCapacity" type="number" min="0" step="0.1" value="2.8" aria-describedby="tankHelp" />
        <button id="useTankButton" class="small" title="Tankinhalt zum Verbrauch hinzufügen">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden focusable="false" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3s5 5 5 8a5 5 0 11-10 0c0-3 5-8 5-8z" fill="var(--blue-water)" />
          </svg>
          Tank verbrauchen
        </button>
      </div>
      <div id="tankHelp" class="hint">Klick addiert den Tankinhalt zur Verbrauchszählung (z. B. 2.8 L).</div>
    </div>

    <div style="margin-top:12px;">
      <label for="consumeInput">Manuell Liter hinzufügen (z. B. 1)</label>
      <div class="row">
        <input id="consumeInput" type="number" min="0" step="0.1" value="1" />
        <button id="consumeButton" class="small">Hinzufügen</button>
        <button id="consume1Button" class="small ghost">+1 L</button>
      </div>
      <div class="hint">Gib z. B. 1 L ein, um Liter zum Verbrauch zu addieren.</div>
    </div>

    <div style="margin-top:16px;" class="row" aria-label="Rückgängig und Reset Buttons">
      <button id="undoButton" class="ghost small" disabled title="Letzten Schritt rückgängig machen" aria-disabled="true" aria-label="Rückgängig">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Rückgängig
      </button>
      <button id="resetButton" class="ghost small" disabled title="Alles zurücksetzen" aria-disabled="true" aria-label="Reset">
        Reset
      </button>
    </div>
  </div>

  <div class="display" aria-live="polite" aria-label="Wasserstand Anzeige">
    <div class="tank-wrap" role="img" aria-label="Tank-Füllstand">
      <svg id="tankSvg" viewBox="0 0 120 260" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <rect x="12" y="20" rx="12" ry="12" width="96" height="200" fill="none" stroke="#d6dde3" stroke-width="4" />
        <rect id="fillRect" x="12" y="220" width="96" height="0" rx="10" ry="10" fill="var(--blue-water)" />
        <path d="M60 12c-4 0-16 12-16 24 0 22 32 22 32 0 0-12-12-24-16-24z" fill="var(--blue-water)" opacity="0.9" />
      </svg>
    </div>

    <div class="stats">
      <div class="big" id="litersToDescaleText">Nächste Entkalkung: — L</div>
      <div class="muted" id="remainingText">Verbleibend: — L</div>
      <div class="fillbar" aria-hidden="true">
        <div class="fill" id="progressFill" style="width:0%"></div>
      </div>
      <div class="notice" id="notice">Jetzt entkalken!</div>
      <div class="hardness-warning" id="hardnessWarning">Achtung: Häufigeres Entkalken empfohlen (Wasserhärte über 21 °dH)!</div>
    </div>
  </div>

  <div id="calendarSection" style="grid-column: 1 / -1; margin-top: 24px;">
    <label for="descaleDate">Entkalkungstermin wählen</label>
    <input type="date" id="descaleDate" style="width: 100%; max-width: 200px; margin-bottom: 8px;" />
    <button id="addCalendarBtn" class="small" disabled style="min-width: 200px;">Termin zum Kalender hinzufügen</button>
  </div>

  <footer>Hinweis: Die berechnete Entkalkungsfrequenz ist als unverbindliche Empfehlung zu verstehen und kann je nach Wasserqualität und Nutzungsverhalten variieren.</footer>
</div>

<div id="themeToggleWrapper" role="button" tabindex="0" aria-pressed="false" aria-label="Darkmode umschalten" style="margin-top: 12px; text-align: center; cursor:pointer;">
  <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="display:inline-block; vertical-align: middle;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
  <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="display:none; vertical-align: middle;">
    <path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0021 12.79z"></path>
  </svg>
</div>

<script>
(function() {
  let usedLiters = 0;
  let litersToDescale = null;
  let undoStack = [];

  const waterHardnessInput = document.getElementById('waterHardness');
  const calculateButton = document.getElementById('calculateButton');
  const resetButton = document.getElementById('resetButton');

  const tankCapacityInput = document.getElementById('tankCapacity');
  const useTankButton = document.getElementById('useTankButton');

  const consumeInput = document.getElementById('consumeInput');
  const consumeButton = document.getElementById('consumeButton');
  const consume1Button = document.getElementById('consume1Button');

  const undoButton = document.getElementById('undoButton');

  const litersToDescaleText = document.getElementById('litersToDescaleText');
  const remainingText = document.getElementById('remainingText');
  const progressFill = document.getElementById('progressFill');
  const notice = document.getElementById('notice');
  const hardnessWarning = document.getElementById('hardnessWarning');
  const fillRect = document.getElementById('fillRect');

  const descaleDateInput = document.getElementById('descaleDate');
  const addCalendarBtn = document.getElementById('addCalendarBtn');

  const themeToggleWrapper = document.getElementById('themeToggleWrapper');
  const sunIcon = document.getElementById('sunIcon');
  const moonIcon = document.getElementById('moonIcon');

  function fmt(num) {
    return Number.parseFloat(num).toFixed(1);
  }

 function updateDisplay() {
  if (litersToDescale === null) {
    // ... unverändert
  }

  const remaining = litersToDescale - usedLiters;
  let perc = (usedLiters / litersToDescale) * 100;
  if (perc > 100) perc = 100;

  litersToDescaleText.textContent = `Nächste Entkalkung: ${fmt(litersToDescale)} L`;
  remainingText.textContent = `Verbleibend: ${fmt(remaining)} L`;

  // Farbe je nach Fortschritt (grün >50%, gelb 25-50%, rot <25%)
  let fillColor = 'var(--progress-green)';
  if (perc >= 75) fillColor = 'var(--progress-red)';
  else if (perc >= 50) fillColor = 'var(--progress-yellow)';
  else fillColor = 'var(--progress-green)';

  progressFill.style.width = perc + '%';
  progressFill.style.backgroundColor = fillColor;

  const fillHeight = Math.round((usedLiters / litersToDescale) * 200);
  fillRect.setAttribute('height', fillHeight);
  fillRect.setAttribute('y', 220 - fillHeight);

  notice.style.display = remaining <= 0 ? 'block' : 'none';

  // Warnung nur "Achtung: Häufigeres Entkalken empfohlen!" bei >21 °dH, kein Zusatztext
  if (parseFloat(waterHardnessInput.value) > 21) {
    hardnessWarning.textContent = 'Achtung: Häufigeres Entkalken empfohlen!';
    hardnessWarning.style.display = 'block';
  } else {
    hardnessWarning.style.display = 'none';
  }

  resetButton.disabled = false;
  undoButton.disabled = undoStack.length === 0;
  addCalendarBtn.disabled = descaleDateInput.value === '' || litersToDescale === null;
  calculateButton.disabled = true;

}


  function saveState() {
    const state = {
      usedLiters,
      litersToDescale,
      undoStack,
      waterHardness: waterHardnessInput.value,
      tankCapacity: tankCapacityInput.value,
      descaleDate: descaleDateInput.value
    };
    localStorage.setItem('entkalkungsrechner', JSON.stringify(state));
  }

  function loadState() {
    const state = localStorage.getItem('entkalkungsrechner');
    if (!state) return;
    try {
      const obj = JSON.parse(state);
      usedLiters = obj.usedLiters || 0;
      litersToDescale = obj.litersToDescale || null;
      undoStack = obj.undoStack || [];
      waterHardnessInput.value = obj.waterHardness || '';
      tankCapacityInput.value = obj.tankCapacity || '2.8';
      descaleDateInput.value = obj.descaleDate || '';
      updateDisplay();
    } catch (e) {}
  }

  waterHardnessInput.addEventListener('input', () => {
    const hardness = parseFloat(waterHardnessInput.value);
    calculateButton.disabled = isNaN(hardness) || hardness <= 0;
  });

  calculateButton.addEventListener('click', () => {
    const hardness = parseFloat(waterHardnessInput.value);
    if (isNaN(hardness) || hardness <= 0) {
      alert('Bitte gültige Wasserhärte eingeben (größer 0).');
      litersToDescale = null;
      updateDisplay();
      saveState();
      return;
    }
    litersToDescale = 2000 / hardness;
    usedLiters = 0;
    undoStack = [];
    updateDisplay();
    saveState();
  });

  resetButton.addEventListener('click', () => {
    if (!confirm('Sind Sie sicher, dass Sie alle Daten zurücksetzen möchten?')) return;
    usedLiters = 0;
    litersToDescale = null;
    undoStack = [];
    waterHardnessInput.value = '';
    tankCapacityInput.value = '2.8';
    descaleDateInput.value = '';
    updateDisplay();
    saveState();
  });

  useTankButton.addEventListener('click', () => {
    if (litersToDescale === null) return;
    const tank = parseFloat(tankCapacityInput.value);
    if (isNaN(tank) || tank <= 0) {
      alert('Bitte gültige Tankkapazität eingeben.');
      return;
    }
    undoStack.push(usedLiters);
    usedLiters += tank;
    if (usedLiters > litersToDescale) usedLiters = litersToDescale;
    updateDisplay();
    saveState();
  });

  consumeButton.addEventListener('click', () => {
    if (litersToDescale === null) return;
    const amount = parseFloat(consumeInput.value);
    if (isNaN(amount) || amount <= 0) {
      alert('Bitte gültigen Wert zum Hinzufügen eingeben (größer 0).');
      return;
    }
    undoStack.push(usedLiters);
    usedLiters += amount;
    if (usedLiters > litersToDescale) usedLiters = litersToDescale;
    updateDisplay();
    saveState();
  });

  consume1Button.addEventListener('click', () => {
    if (litersToDescale === null) return;
    undoStack.push(usedLiters);
    usedLiters += 1;
    if (usedLiters > litersToDescale) usedLiters = litersToDescale;
    updateDisplay();
    saveState();
  });

  undoButton.addEventListener('click', () => {
    if (undoStack.length === 0) return;
    usedLiters = undoStack.pop();
    updateDisplay();
    saveState();
  });

  addCalendarBtn.addEventListener('click', () => {
    if (!descaleDateInput.value) {
      alert('Bitte erst ein Datum für den Entkalkungstermin auswählen.');
      return;
    }
    const date = new Date(descaleDateInput.value);
    if (isNaN(date)) {
      alert('Ungültiges Datum.');
      return;
    }
    const startDate = date.toISOString().split('T')[0].replace(/-/g, '');
    const endDate = new Date(date);
    endDate.setDate(date.getDate() + 1);
    const endDateStr = endDate.toISOString().split('T')[0].replace(/-/g, '');

    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=Entkalkung+fällig&dates=${startDate}/${endDateStr}&details=Entkalkung+deiner+Maschine+fällig+am+${date.toLocaleDateString()}&sf=true&output=xml`;

    window.open(url, '_blank');
  });

  function setTheme(dark) {
    if (dark) {
      document.body.dataset.theme = 'dark';
      sunIcon.style.display = 'none';
      moonIcon.style.display = 'inline-block';
      themeToggleWrapper.setAttribute('aria-pressed', 'true');
      localStorage.setItem('theme', 'dark');
    } else {
      document.body.dataset.theme = 'light';
      sunIcon.style.display = 'inline-block';
      moonIcon.style.display = 'none';
      themeToggleWrapper.setAttribute('aria-pressed', 'false');
      localStorage.setItem('theme', 'light');
    }
  }

  themeToggleWrapper.addEventListener('click', () => {
    const dark = document.body.dataset.theme === 'dark';
    setTheme(!dark);
  });
  themeToggleWrapper.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      themeToggleWrapper.click();
    }
  });

  loadState();

  // Standard hell, erst Darkmode auf Wunsch
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') setTheme(true);
  else setTheme(false);
})();
</script>
</body>
</html>




